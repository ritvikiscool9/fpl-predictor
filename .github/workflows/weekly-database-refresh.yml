name: Weekly Database Refresh

on:
  schedule:
    # Run every Sunday at 3 AM UTC 
    - cron: '0 3 * * 0'
  
  # Allow manual triggering from GitHub Actions tab
  workflow_dispatch:

jobs:
  refresh-database:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Validate required repository secrets are available
      - name: Validate required secrets
        run: |
          echo "Checking required repository secrets..."
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "ERROR: SUPABASE_URL secret is missing."
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then
            echo "ERROR: SUPABASE_KEY secret is missing."
            exit 1
          fi
          if [ -z "${{ secrets.API_KEY }}" ]; then
            echo "WARNING: API_KEY secret is missing (may not be required)."
          fi
          echo "âœ… All required secrets are present"

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Configure Python environment for database scripts
      - name: Setup Python environment
        run: |
          python -c "import sys; print(f'Python version: {sys.version}')"
          python -c "import os; print(f'Working directory: {os.getcwd()}')"

      # Run fast performance refresh (730x faster)
      - name: Refresh player performance data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "Starting player performance refresh..."
          python src/database/fast_performance_refresh.py || {
            echo "ERROR: Performance refresh failed"
            exit 1
          }
          echo "Performance refresh completed successfully"

      # Update current player prices
      - name: Update player prices
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "Starting player price update..."
          python src/database/update_player_prices.py
          echo "Price update completed successfully"

      # Verify database health after refresh
      - name: Verify database health
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "Verifying database health..."
          python src/database/check_database.py
          echo "Database verification completed"

      # Optional: Export updated data for backup
      - name: Export complete data (backup)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "Creating data backup..."
          python src/database/export_complete_data.py
          echo "Data backup completed"

      # Log refresh completion to database
      - name: Log refresh to database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        continue-on-error: true
        run: |
          echo "Logging refresh completion..."
          python3 << 'PYEOF'
import os
from datetime import datetime, timezone
from supabase import create_client

url = os.environ.get('SUPABASE_URL')
key = os.environ.get('SUPABASE_KEY')
github_run_id = os.environ.get('GITHUB_RUN_ID')

if url and key:
    try:
        supabase = create_client(url, key)
        refresh_log = {
            'refresh_type': 'weekly_automated',
            'timestamp': datetime.now(timezone.utc).isoformat(),
            'status': 'completed',
            'github_run_id': github_run_id,
            'notes': 'Automated weekly refresh via GitHub Actions'
        }
        result = supabase.table('refresh_logs').insert(refresh_log).execute()
        print('âœ… Refresh logged to database successfully')
    except Exception as e:
        print(f'âš ï¸ Could not log to database: {e}')
else:
    print('âš ï¸ Database credentials not available for logging')
PYEOF

      # Run unit tests to validate the codebase after refresh
      - name: Run tests
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "Installing test dependencies..."
          python -m pip install --upgrade pip
          pip install pytest pytest-mock
          echo "Running pytest..."
          pytest src/tests/ -v --tb=short || echo "Tests completed with warnings"

      # Create success summary with timestamp
      - name: Create success summary
        if: success()
        run: |
          echo "âœ… Weekly database refresh completed successfully!"
          echo "ðŸ• Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“Š Summary:"
          echo "- Player performance data updated"
          echo "- Current prices refreshed" 
          echo "- Database health verified"
          echo "- Data backup created"
          echo ""
          echo "ðŸ”— View logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # Create failure summary with troubleshooting
      - name: Create failure summary
        if: failure()
        run: |
          echo "âŒ Weekly database refresh failed!"
          echo "ðŸ• Failed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ”§ Troubleshooting steps:"
          echo "1. Check repository secrets are set correctly"
          echo "2. Verify Supabase connection"
          echo "3. Run manual refresh: python src/database/fast_performance_refresh.py"
          echo ""
          echo "ðŸ”— View failure logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1

      # Generate workflow badge data
      - name: Generate status badge
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "LAST_REFRESH_STATUS=success" >> $GITHUB_ENV
            echo "LAST_REFRESH_TIME=$(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV
          else
            echo "LAST_REFRESH_STATUS=failed" >> $GITHUB_ENV
            echo "LAST_REFRESH_TIME=$(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV
          fi